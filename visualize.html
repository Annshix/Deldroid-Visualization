<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="http://code.jquery.com/jquery.js"></script>
    <link href="bootstrap-3.3.7-dist/css/bootstrap.min.css" rel="stylesheet" media="screen">
    <link href="css/custom.css" rel="stylesheet">
    <script src="bootstrap-3.3.7-dist/js/bootstrap.js"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="http://gildas-lormeau.github.io/zip.js/demos/zip.js"></script>
    <script src="http://gildas-lormeau.github.io/zip.js/demos/mime-types.js"></script>
    <script src="file_read.js"></script>
    <title></title>
</head>
<body>
    <div class="page-header">
        <h2 class="capital"> Visualization
            <small class="capital-1"> Graph </small>
        </h2>
    </div>

    <div class="container-1">
        <div class="left-pane">
            <div class="container-2">
                <h4 class="capital-1"> Details </h4>
            </div>
            <div id="info" class="container-3"></div>
        </div>
        <div class="right-pane">
            <div class="dropdown option-btn">
                <button type="button" class="btn dropdown-toggle" id="dropdownMenu1" data-toggle="dropdown">Options
                    <span class="caret"></span>
                </button>
                <ul class="dropdown-menu pull-right" role="menu" aria-labelledby="dropdownMenu1">
                    <li role="presentation">
                        <a role="menuitem" tabindex="-1" onclick="PrivilegeEscalation()"> PriviledgeEscalation </a>
                    </li>
                    <li role="presentation">
                        <a role="menuitem" tabindex="-1" onclick="IntentSpoof()"> IntentSpoof </a>
                    </li>
                    <li role="presentation">
                        <a role="menuitem" tabindex="-1" onclick="UnauthorizedIntentReceipt()"> UnauthorizedIntentReceipt </a>
                    </li>
                    <li role="presentation">
                        <a role="menuitem" tabindex="-1" onclick="LP()"> LeastPriviledge </a>
                    </li>
                </ul>
            </div>
            <div id="newgraph" class="container-3"></div>
        </div>
    </div>

    <script>
        x = localStorage.getItem('link_dpg1');
        console.log(x);
      $("#file-input").change(function (e) {
        var file = this.file[0];
        window.un = new UnZipArchive(file);
        un.getData( function(){
          var array = un.getEntries();
          for(var i = 0; i < array.length; i++){
            console.log(array[i]);
          }
        });
      });
      var links = [{source:"edu.uci.seal.fungame.Main",target:"edu.uci.seal.fungame.LevelUp",type:"domain-explicit-communication"},
        {source:"edu.uci.seal.fungame.LevelUp",target:"edu.uci.seal.messaging.Sender",type:"domain-implicit-communication"},
        {source:"edu.uci.seal.messaging.Composer",target:"edu.uci.seal.messaging.Sender",type:"domain-implicit-communication"},
        {source:"edu.uci.seal.fungame.LevelUp",target:"SMS",type:"domain-permission-enforcement"},
        {source:"edu.uci.seal.fungame.LevelUp",target:"LOCATION",type:"domain-permission-granted"},
        {source:"edu.uci.seal.fungame.Main",target:"LOCATION",type:"domain-permission-granted"},
        {source:"edu.uci.seal.messaging.ListMsgs",target:"BLUETOOTH",type:"domain-permission-granted"},
        {source:"edu.uci.seal.messaging.Composer",target:"SMS",type:"domain-permission-granted"},
        {source:"edu.uci.seal.messaging.Sender",target:"SMS",type:"domain-permission-granted"},
        {source:"edu.uci.seal.fungame.LevelUp",target:"LOCATION",type:"domain-permission-usage"},
        {source:"edu.uci.seal.messaging.ListMsgs",target:"BLUETOOTH",type:"domain-permission-usage"},
        {source:"edu.uci.seal.messaging.Sender",target:"SMS",type:"domain-permission-usage"}];

      var privilegeEscalationInstances = [{source:"edu.uci.seal.messaging.Sender",target:"edu.uci.seal.messaging.ListMsgs",value:"SMS"}];
      var intentSpoofingInstances = [{source:"malicious(spoofing)",target:"victim",value:"correct"}];
      var unauthorizedIntentReceiptInstances = [{source:"malicious(unauthorized)",target:"victim",value:"correct"}];

      var nodev = [{name:"edu.uci.seal.fungame.LevelUp", value:"LevelUp"},
        {name:"edu.uci.seal.fungame.Main", value:"Main"},
        {name:"edu.uci.seal.messaging.Composer", value:"Composer"},
        {name:"edu.uci.seal.messaging.ListMsgs", value:"ListMsg"},
        {name:"edu.uci.seal.messaging.Sender", value:"Sender"},
        {name:"SMS",value:"SMS"},
        {name:"LOCATION",value:"LOCATION"},
        {name:"BLUETOOTH",value:"BLUETOOTH"}];

      var tag;

      var svg = d3.select("div#newgraph").append("svg:svg")
        .attr("width", window.innerWidth)
        .attr("height", window.innerHeight);

      // Per-type markers, as they don't inherit styles.
      svg.append("svg:defs").selectAll("marker")
        .data(["domain-implicit-communication", "domain-explicit-communication", "domain-permission-enforcement","domain-permission-granted","domain-permission-usage"])
        .enter().append("svg:marker")
        .attr("id", String)
        .attr("viewBox", "0 -5 10 10")
        .attr("refX", 15)
        .attr("refY", -1.5)
        .attr("markerWidth", 6)
        .attr("markerHeight", 6)
        .attr("orient", "auto")
        .append("svg:path")
        .attr("d", "M0,-5L10,0L0,5");

      function LP(){
        svg.selectAll("g").remove();
        tag = "LP";
        visualization(clone(links));
      }

      function PrivilegeEscalation(){
        svg.selectAll("g").remove();
        tag = "P";
        visualization(clone(privilegeEscalationInstances));
      }

      function IntentSpoof(){
        svg.selectAll("g").remove();
        tag = "I";
        visualization(clone(intentSpoofingInstances));
      }

      function UnauthorizedIntentReceipt(){
        svg.selectAll("g").remove();
        tag = "U";
        visualization(clone(unauthorizedIntentReceiptInstances));
      }

      function visualization(links){
//sort links by source, then target
        links.sort(function(a,b) {
          if (a.source > b.source) {return 1;}
          else if (a.source < b.source) {return -1;}
          else {
            if (a.target > b.target) {return 1;}
            if (a.target < b.target) {return -1;}
            else {return 0;}
          }
        });
//any links with duplicate source and target get an incremented 'linknum'
        for (var i=0; i<links.length; i++) {
          if (i != 0 && links[i].source == links[i-1].source && links[i].target == links[i-1].target) {
            links[i].linknum = links[i-1].linknum + 1;
          }
          else {links[i].linknum = 1;}
        }

        var nodes = {};

        // Compute the distinct nodes from the links.
        links.forEach(function(link) {
          link.source = nodes[link.source] || (nodes[link.source] = {name: link.source});
          link.target = nodes[link.target] || (nodes[link.target] = {name: link.target});
        });

        var w = 600,
          h = 600;

        var force = d3.layout.force()
          .nodes(d3.values(nodes))
          .links(links)
          .size([w, h])
          .linkDistance(100)
          .charge(-300)
          .on("tick", tick)
          .start();

        var path = svg.append("svg:g").selectAll("path")
          .data(force.links())
          .enter().append("svg:path")
          .attr("class", function(d) { return "link " + d.type; })
          .attr("marker-end", function(d) { return "url(#" + d.type + ")"; });

        var circle = svg.append("svg:g").selectAll("circle")
          .data(force.nodes())
          .enter().append("svg:circle")
          .attr("r", 6)
          .call(force.drag)
          .on("mouseover", function(d){
            if(tag == "LP"){
              for(var i = 0; i<nodev.length; i++){
                if(nodev[i].name == d.name){
                  document.getElementById("info").innerHTML="<label class='infotype'>"+nodev[i].value+"</label>";}
              }}

            if(tag == "P"){
              for(var i = 0; i <links.length; i++){
                if(links[i].source.name == d.name || links[i].target.name == d.name)
                  document.getElementById("info").innerHTML="<label class='infotype'>" + "resource: " + links[i].value + "</label>";}

            }

            if(tag == "I"){
              for(var i = 0; i <intentSpoofingInstances.length; i++){
                if(links[i].source.name == d.name || links[i].target.name == d.name)
                  document.getElementById("info").innerHTML = "<label class='infotype'>" + "legitimate: " + links[i].value + "</label>";}
            }

            if(tag == "U"){
              for(var i = 0; i <unauthorizedIntentReceiptInstances.length; i++){
                if(links[i].source.name == d.name || links[i].target.name == d.name)
                  document.getElementById("info").innerHTML = "<label class='infotype'>" + "legitimate: " + links[i].value+"</label>";}
            }

            return tooltip.style("visibility", "visible");})
          //.on("mousemove", function(){return tooltip.style("top",(d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");})
          .on("mouseout", function(){
            document.getElementById("info").innerHTML="";
            return tooltip.style("visibility", "hidden");});

        var tooltip = d3.select("div#newgraph")
          .append("div")
          .style("position", "absolute")
          .style("z-index", "10")
          .style("visibility", "hidden");

        var text = svg.append("svg:g").selectAll("g")
          .data(force.nodes())
          .enter().append("svg:g");

        // A copy of the text with a thick white stroke for legibility.
        text.append("svg:text")
          .attr("x", 8)
          .attr("y", ".31em")
          .attr("class", "shadow")
          .text(function(d) { return d.name; });

        text.append("svg:text")
          .attr("x", 8)
          .attr("y", ".31em")
          .text(function(d) { return d.name; });

        // Use elliptical arc path segments to doubly-encode directionality.
        function tick() {
          path.attr("d", function(d) {
            var dx = d.target.x - d.source.x,
              dy = d.target.y - d.source.y,
              dr = Math.sqrt(dx * dx + dy * dy);
            //  dr = 75/d.linknum;  //linknum is defined above
            return "M" + d.source.x + "," + d.source.y + "A" + dr + "," + dr + " 0 0,1 " + d.target.x + "," + d.target.y;
          });

          circle.attr("transform", function(d) {
            return "translate(" + d.x + "," + d.y + ")";
          });

          text.attr("transform", function(d) {
            return "translate(" + d.x + "," + d.y + ")";
          });
        }
      }
      console.log('1');

      function clone(obj) {
        // Handle the 3 simple types, and null or undefined
        if (null == obj || "object" != typeof obj) return obj;

        // Handle Date
        if (obj instanceof Date) {
          var copy = new Date();
          copy.setTime(obj.getTime());
          return copy;
        }

        // Handle Array
        if (obj instanceof Array) {
          var copy = [];
          for (var i = 0, len = obj.length; i < len; i++) {
            copy[i] = clone(obj[i]);
          }
          return copy;
        }

        // Handle Object
        if (obj instanceof Object) {
          var copy = {};
          for (var attr in obj) {
            if (obj.hasOwnProperty(attr)) copy[attr] = clone(obj[attr]);
          }
          return copy;
        }
        console.log('1');

        throw new Error("Unable to copy obj! Its type isn't supported.");
      }
    </script>
</body>
</html>